name: Build and Release Alfred Workflow

on:
  push:
    tags:
      - 'v*'
  workflow_dispatch:
    inputs:
      version:
        description: 'Version number (e.g., v0.1.0)'
        required: true
        default: 'v0.1.0'

permissions:
  contents: write
  actions: read
  security-events: write

jobs:
  build:
    runs-on: macos-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Set version
      id: version
      run: |
        if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
          echo "VERSION=${{ github.event.inputs.version }}" >> $GITHUB_OUTPUT
        else
          echo "VERSION=${GITHUB_REF#refs/tags/}" >> $GITHUB_OUTPUT
        fi
        
    - name: Validate version in info.plist
      run: |
        VERSION="${{ steps.version.outputs.VERSION }}"
        VERSION_NUMBER="${VERSION#v}"
        
        # éªŒè¯info.plistä¸­çš„ç‰ˆæœ¬å·
        echo "Expected version: $VERSION_NUMBER"
        echo "Current version in info.plist:"
        grep -A1 '<key>version</key>' src/info.plist | tail -1 | sed 's/.*<string>\(.*\)<\/string>.*/\1/' | tr -d '\t'
        
        # æ£€æŸ¥ç‰ˆæœ¬æ˜¯å¦åŒ¹é…
        CURRENT_VERSION=$(grep -A1 '<key>version</key>' src/info.plist | tail -1 | sed 's/.*<string>\(.*\)<\/string>.*/\1/' | tr -d '\t')
        if [ "$CURRENT_VERSION" != "$VERSION_NUMBER" ]; then
          echo "âŒ Version mismatch! Expected: $VERSION_NUMBER, Found: $CURRENT_VERSION"
          exit 1
        else
          echo "âœ… Version matches: $VERSION_NUMBER"
        fi
        
    - name: Create Alfred Workflow package
      run: |
        # åˆ›å»ºä¸´æ—¶ç›®å½•
        mkdir -p build
        
        # å¤åˆ¶æ‰€æœ‰æºæ–‡ä»¶åˆ°ä¸´æ—¶ç›®å½•
        cp -r src/* build/
        
        # åˆ›å»º.alfredworkflowæ–‡ä»¶ï¼ˆå®é™…ä¸Šæ˜¯zipæ–‡ä»¶ï¼‰
        cd build
        zip -r "../alfred-translator-${{ steps.version.outputs.VERSION }}.alfredworkflow" .
        cd ..
        
        # éªŒè¯æ–‡ä»¶åˆ›å»º
        ls -la alfred-translator-*.alfredworkflow
        
    - name: Create Release and Upload Asset
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      run: |
        VERSION="${{ steps.version.outputs.VERSION }}"
        RELEASE_FILE="alfred-translator-${VERSION}.alfredworkflow"
        
        # åˆ›å»ºrelease notesæ–‡ä»¶
        cat > release_notes.md << EOF
        ## ğŸš€ Alfred ä¸­è‹±ç¿»è¯‘å·¥å…· ${VERSION}
        
        ### âœ¨ ä¸»è¦åŠŸèƒ½
        - ğŸ”„ ä¸­æ–‡åˆ°è‹±æ–‡å®æ—¶ç¿»è¯‘
        - ğŸ”Š ç¿»è¯‘ç»“æœè¯­éŸ³æœ—è¯»
        - ğŸ’¾ ç¿»è¯‘ç»“æœæ™ºèƒ½ç¼“å­˜
        - âš™ï¸ å¯é…ç½®çš„APIè®¾ç½®
        - ğŸ“‹ è‡ªåŠ¨å¤åˆ¶åˆ°å‰ªè´´æ¿
        
        ### ğŸ“¦ å®‰è£…æ–¹æ³•
        1. ä¸‹è½½ä¸‹æ–¹çš„ \`.alfredworkflow\` æ–‡ä»¶
        2. åŒå‡»æ–‡ä»¶è‡ªåŠ¨å®‰è£…åˆ°Alfred
        3. ä½¿ç”¨ \`tset\` å‘½ä»¤é…ç½®APIå¯†é’¥
        
        ### ğŸ¯ ä½¿ç”¨æ–¹æ³•
        - \`t [ä¸­æ–‡æ–‡æœ¬]\` - ç¿»è¯‘ä¸­æ–‡åˆ°è‹±æ–‡
        - \`âŒ˜ + å›è½¦\` - æœ—è¯»ç¿»è¯‘ç»“æœ
        - \`tset\` - æ‰“å¼€è®¾ç½®ç•Œé¢
        
        ### ğŸ“š å®Œæ•´æ–‡æ¡£
        è¯·æŸ¥çœ‹ [README.md](https://github.com/${{ github.repository }}/blob/main/README.md)
        
        ---
        
        **ä¸‹è½½æ–‡ä»¶:** \`${RELEASE_FILE}\`
        EOF
        
        # ä½¿ç”¨gh CLIåˆ›å»ºrelease
        echo "Creating release ${VERSION}..."
        gh release create "${VERSION}" \
          --title "Alfred ä¸­è‹±ç¿»è¯‘å·¥å…· ${VERSION}" \
          --notes-file release_notes.md \
          "${RELEASE_FILE}#Alfredç¿»è¯‘å·¥å…·å®‰è£…åŒ…"
        
        echo "âœ… Release ${VERSION} created successfully!"
